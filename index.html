<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>One Stop ‚Ä¢ MP3 Uploader</title>
    <meta
      name="description"
      content="Upload MP3 files and get instant shareable + embeddable links."
    />
    <link rel="icon" href="data:," />
    <style>
      :root {
        --bg: #0f1115; /* dark base */
        --panel: rgba(255, 255, 255, 0.06);
        --text: #e7e9ee;
        --muted: #757d8b;
        --accent: #4f8cff;
        --accent-2: #7c4dff;
        --ok: #32d296;
        --warn: #ffcc00;
        --danger: #ff5a5f;
        --ring: rgba(79, 140, 255, 0.55);
        --shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
        --radius: 18px;
      }
      @media (prefers-color-scheme: light) {
        :root {
          --bg: #0f1115;
          --panel: rgba(255, 255, 255, 0.06);
          --text: #e7e9ee;
          --muted: #757d8b;
          --accent: #4f8cff;
          --accent-2: #7c4dff;
          --ok: #32d296;
          --warn: #ffcc00;
          --danger: #ff5a5f;
          --ring: rgba(79, 140, 255, 0.55);
          --shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
          --radius: 18px;
        }

        .light {
          --bg: #f7f8fb;
          --panel: #ffffff;
          --text: #0f1115;
          --muted: #596175;
          --ring: rgba(79, 140, 255, 0.45);
          --shadow: 0 10px 25px rgba(16, 24, 40, 0.08);
        }
      }
      html,
      body {
        height: 100%;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font: 15px/1.45 system-ui, -apple-system, Segoe UI, Roboto,
          "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji",
          "Segoe UI Emoji";
        color: var(--text);
        background: radial-gradient(
            1200px 800px at 10% -10%,
            rgba(124, 77, 255, 0.15),
            transparent
          ),
          radial-gradient(
            1000px 600px at 110% 10%,
            rgba(79, 140, 255, 0.18),
            transparent
          ),
          var(--bg);
      }
      .wrap {
        max-width: 1040px;
        margin: 0 auto;
        padding: 28px;
      }
      header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 16px;
        margin-bottom: 28px;
      }
      .brand {
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .logo {
        width: 36px;
        height: 36px;
        border-radius: 12px;
        background: linear-gradient(135deg, var(--accent), var(--accent-2));
        box-shadow: var(--shadow);
      }
      h1 {
        font-size: clamp(18px, 2.8vw, 24px);
        margin: 0;
      }
      .muted {
        color: var(--muted);
      }
      .controls {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .btn {
        appearance: none;
        border: 1px solid transparent;
        background: var(--panel);
        color: var(--text);
        padding: 10px 14px;
        border-radius: 12px;
        cursor: pointer;
        transition: 0.2s ease;
        box-shadow: var(--shadow);
      }
      .btn:hover {
        transform: translateY(-1px);
      }
      .btn:focus {
        outline: 3px solid var(--ring);
        outline-offset: 2px;
      }

      .grid {
        display: grid;
        grid-template-columns: repeat(12, 1fr);
        gap: 18px;
      }
      .panel {
        grid-column: span 8;
        background: var(--panel);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: var(--radius);
        backdrop-filter: blur(10px);
        box-shadow: var(--shadow);
      }
      .side {
        grid-column: span 4;
      }
      @media (max-width: 920px) {
        .panel {
          grid-column: 1/-1;
        }
        .side {
          grid-column: 1/-1;
        }
      }

      .panel-head {
        padding: 18px 18px 10px;
      }
      .panel-title {
        font-weight: 700;
        font-size: 18px;
      }
      .dropzone {
        position: relative;
        margin: 16px;
        border: 2px dashed rgba(255, 255, 255, 0.18);
        border-radius: calc(var(--radius) - 6px);
        padding: 28px;
        text-align: center;
        transition: 0.2s ease;
      }
      .dropzone.drag {
        border-color: var(--accent);
        box-shadow: inset 0 0 0 2px var(--accent);
      }
      .dropzone input[type="file"] {
        position: absolute;
        inset: 0;
        opacity: 0;
        cursor: pointer;
      }
      .dz-icon {
        width: 52px;
        height: 52px;
        border-radius: 14px;
        display: inline-grid;
        place-items: center;
        margin: 0 auto 10px;
        background: linear-gradient(
          135deg,
          rgba(79, 140, 255, 0.25),
          rgba(124, 77, 255, 0.25)
        );
      }

      .rows {
        padding: 2px 12px 18px;
      }
      .row {
        display: grid;
        grid-template-columns: 42px 1fr auto;
        gap: 12px;
        align-items: center;
        padding: 10px 8px;
        border-radius: 12px;
      }
      .row + .row {
        margin-top: 6px;
      }
      .row:hover {
        background: rgba(255, 255, 255, 0.06);
      }
      .file-ico {
        width: 42px;
        height: 42px;
        border-radius: 12px;
        background: linear-gradient(
          135deg,
          rgba(79, 140, 255, 0.22),
          rgba(124, 77, 255, 0.22)
        );
        display: grid;
        place-items: center;
      }
      .name {
        font-weight: 600;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      .meta {
        font-size: 12px;
        color: var(--muted);
      }
      .actions {
        display: flex;
        gap: 6px;
      }
      .chip {
        font-size: 12px;
        padding: 6px 8px;
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.08);
      }

      .progress {
        height: 8px;
        width: 100%;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.08);
        overflow: hidden;
      }
      .bar {
        height: 100%;
        width: 0%;
        background: linear-gradient(90deg, var(--accent), var(--accent-2));
        transition: width 0.2s ease;
      }

      .code {
        background: #0b0d12;
        color: #e6edf3;
        border: 1px solid rgba(255, 255, 255, 0.08);
        padding: 12px;
        border-radius: 12px;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", "Courier New", monospace;
        font-size: 12.5px;
        overflow: auto;
      }
      @media (prefers-color-scheme: light) {
        .code {
          background: #111827;
          color: #f3f4f6;
        }
      }

      .note {
        font-size: 13px;
        color: var(--muted);
      }
      .kbd {
        font: 600 12px/1 ui-monospace, Menlo, Monaco, Consolas, "Courier New";
        padding: 4px 6px;
        border-radius: 6px;
        border: 1px solid rgba(255, 255, 255, 0.18);
      }

      /* Toast */
      .toast {
        position: fixed;
        bottom: 18px;
        left: 50%;
        transform: translateX(-50%) translateY(20px);
        opacity: 0;
        transition: 0.25s ease;
        background: var(--panel);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.12);
        color: var(--text);
        padding: 10px 14px;
        border-radius: 12px;
        box-shadow: var(--shadow);
      }
      .toast.show {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <header>
        <div class="brand">
          <div class="logo" aria-hidden="true"></div>
          <div>
            <h1>One Stop</h1>
            <div class="muted">Upload MP3 ‚Üí get link ‚Üí embed anywhere</div>
          </div>
        </div>
        <div class="controls">
          <button class="btn" id="themeToggle" aria-label="Toggle theme">
            üåì Theme
          </button>
          <button class="btn" id="infoButton" aria-haspopup="dialog">
            ‚ÑπÔ∏è Info
          </button>
        </div>
      </header>

      <main class="grid" aria-live="polite">
        <section class="panel" aria-label="Upload panel">
          <div class="panel-head">
            <div class="panel-title">Upload MP3</div>
          </div>
          <div class="dropzone" id="dropzone">
            <div class="dz-icon">üéµ</div>
            <div>
              <strong>Drag & drop</strong> MP3 files here or
              <u>click to choose</u>.
            </div>
            <div class="note" style="margin-top: 6px">
              Max 4.5 MB per file ‚Ä¢ Tip: You can paste from clipboard with
              <span class="kbd">Ctrl/‚åò+V</span>
            </div>
            <input
              type="file"
              id="fileInput"
              accept="audio/mpeg"
              multiple
              aria-label="Choose MP3 files"
            />
          </div>
          <div class="rows" id="rows" aria-label="Upload list">
            <!-- dynamic rows go here -->
            <div id="linkOutput"></div>
          </div>
        </section>

        <aside class="side">
          <div class="panel" style="padding: 16px">
            <h3 style="margin: 6px 6px 12px">Embed Preview</h3>
            <div
              class="code"
              id="embedCode"
              role="region"
              aria-label="Generated embed code"
              tabindex="0"
            >
              Select or upload a file to see its embed code.
            </div>
            <div style="display: flex; gap: 8px; margin-top: 10px">
              <button class="btn" id="copyCode">Copy Code</button>
              <button class="btn" id="openLink" disabled>Open Link</button>
            </div>
            <p class="note" style="margin-top: 12px">
              The code uses a direct MP3 URL. Paste it into SitePlus (HTML
              block) or any site builder that accepts custom HTML.
            </p>
          </div>

          <!-- Pulse player section  -->
          <div class="panel" style="padding: 16px; margin-top: 18px">
            <h3 style="margin: 6px 6px 12px">Pulse Player</h3>
            <div
              id="pulsePlayerContainer"
              role="region"
              aria-label="Pulse MP3 player"
            >
              <!-- container where all players will appear -->
              <div id="players-wrapper"></div>

              <script>
                async function handleUpload() {
                  const form = document.getElementById("uploadForm");
                  const formData = new FormData(form);

                  try {
                    const response = await fetch("/api/upload", {
                      method: "POST",
                      body: formData,
                    });
                    if (!response.ok) throw new Error("Upload failed");

                    const data = await response.json();
                    console.log("Upload response:", data);

                    const fileUrl = data.fileUrl;
                    const fileName = data.uploadResult.fileName;

                    // build a unique ID so multiple players don‚Äôt conflict
                    const uid = "player_" + Date.now();

                    // build PulseEL player
                    const playerHTML = `
      <div class="pulse-audio-player">
        <div class="track-info">
          <div class="title">${fileName}</div>
        </div>
        <div class="player-row">
          <button class="play-pause" id="play-pause-${uid}" aria-label="Play" title="Play/Pause" aria-pressed="false">
            <svg viewBox="0 0 24 24" width="26" height="26"><polygon points="6 4 20 12 6 20"/></svg>
            <span class="pulse-ring"></span>
          </button>
          <div class="progress-container" id="progress-container-${uid}">
            <div class="progress-bar" id="progress-bar-${uid}"></div>
            <div class="progress-handle" id="progress-handle-${uid}"></div>
          </div>
          <div class="time-container">
            <span id="current-time-${uid}">0:00</span> /
            <span id="duration-${uid}">0:00</span>
          </div>
          <div class="volume-container">
            <button class="mute-button" id="mute-button-${uid}" title="Mute/Unmute">
              <svg viewBox="0 0 24 24" width="20" height="20"><polygon points="3 9 9 9 13 5 13 19 9 15 3 15 3 9"></polygon></svg>
            </button>
            <input type="range" id="volume-${uid}" min="0" max="1" step="0.01" value="1"/>
          </div>
        </div>
        <audio id="audio-${uid}" preload="metadata">
          <source src="${fileUrl}" type="audio/mpeg"/>
        </audio>
      </div>
    `;

                    // embed iframe code (use same HTML)
                    const embedHtml = `
<iframe srcdoc='${playerHTML.replace(/'/g, "&apos;")}'
  style="border:none;width:480px;height:200px;" frameborder="0"></iframe>`;

                    // wrap player + embed tools
                    const wrapper = document.createElement("div");
                    wrapper.style.marginBottom = "30px";
                    wrapper.innerHTML = `
      ${playerHTML}
      <div class="embed-tools" style="margin-top:10px;">
        <textarea readonly style="width:100%;height:120px;">${embedHtml.trim()}</textarea>
        <button onclick="copyEmbed(this)">Copy Embed Code</button>
      </div>
    `;

                    // append to players wrapper
                    document
                      .getElementById("players-wrapper")
                      .appendChild(wrapper);

                    // re-init just this player
                    initAudioPlayer(`#${wrapper.querySelector("audio").id}`);
                  } catch (err) {
                    console.error("Error uploading:", err);
                    alert("Upload failed: " + err.message);
                  }
                }

                function copyEmbed(button) {
                  const textarea = button.previousElementSibling;
                  textarea.select();
                  document.execCommand("copy");
                  alert("Embed code copied!");
                }
              </script>

              <p class="note">
                This player has been styled exactly as what you see. Copy Code
                and simple paste it anywhere.
              </p>
            </div>
          </div>

          <div class="panel" style="padding: 16px; margin-top: 18px">
            <h3 style="margin: 6px">Tips</h3>
            <ul class="note" style="margin: 6px 0 0 16px; padding: 0 0 6px 0">
              <li>Keep filenames simple (a-z, 0-9, dashes).</li>
              <li>
                Normalize audio levels before upload for consistent volume.
              </li>
              <li>
                Use the same host for all embeds to avoid mixed content warnings
                (HTTP vs HTTPS).
              </li>
            </ul>
          </div>
        </aside>
      </main>
    </div>

    <div class="toast" id="toast" role="status" aria-live="polite"></div>

    <dialog
      id="infoDialog"
      style="
        border: none;
        border-radius: 16px;
        padding: 0;
        max-width: 560px;
        width: 96%;
      "
    >
      <div style="padding: 18px 18px 10px; font-weight: 700">
        How uploads work
      </div>
      <div style="padding: 0 18px 18px" class="note">
        When you choose or drop an MP3 file here, it‚Äôs uploaded directly to our
        secure cloud storage (powered by Supabase). <br /><br />
        Each file gets a unique public link that you can: <br />
        <br />

        Copy and share anywhere. <br />
        <br />

        Embed on your client‚Äôs website with the provided HTML audio player code.
        <br />
        <br />

        The file is stored in a public bucket, so the link will always work
        without logging in. We don‚Äôt alter your audio ‚Äî the exact file you
        upload is the one that will play.
        <br />
        <br />
        Tip: Keep filenames simple (letters, numbers, and dashes) for the
        cleanest links.
      </div>
      <div
        style="
          display: flex;
          gap: 10px;
          justify-content: flex-end;
          padding: 0 18px 18px;
        "
      >
        <button
          class="btn"
          onclick="document.getElementById('infoDialog').close()"
        >
          Close
        </button>
      </div>
    </dialog>

    <script defer>
      const MAX_SIZE = 4.5 * 1024 * 1024; // 4.5 MB

      async function uploadToServer(file, onProgress) {
        if (!file) throw new Error("No file provided");
        if (file.size > MAX_SIZE)
          throw new Error(`File exceeds max size of ${MAX_SIZE} bytes`);

        const formData = new FormData();
        formData.append("file", file);

        return new Promise((resolve, reject) => {
          const xhr = new XMLHttpRequest();
          xhr.open("POST", "/api/upload-file", true);

          // Progress event handler for upload
          xhr.upload.onprogress = (event) => {
            if (event.lengthComputable && typeof onProgress === "function") {
              onProgress(event.loaded / event.total); // fraction from 0 to 1
            }
          };

          xhr.onload = () => {
            if (xhr.status >= 200 && xhr.status < 300) {
              try {
                const response = JSON.parse(xhr.responseText);
                if (response.success) {
                  resolve({ url: response.fileUrl });
                } else {
                  reject(
                    new Error(
                      "Upload failed: " + (response.error || "unknown error")
                    )
                  );
                }
              } catch (parseError) {
                reject(new Error("Invalid JSON response from server"));
              }
            } else {
              reject(
                new Error(`Upload failed: ${xhr.status} ${xhr.responseText}`)
              );
            }
          };

          xhr.onerror = () =>
            reject(new Error("Upload failed (network error)"));

          // Send the form data containing the file
          xhr.send(formData);
        });
      }
    </script>
    <script src="scripts/ui-helper.js"></script>
  </body>
</html>
